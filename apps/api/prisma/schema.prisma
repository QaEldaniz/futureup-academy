generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ADMIN USERS
// ==========================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(ADMIN)
  avatar    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  EDITOR
}

// ==========================================
// COURSES
// ==========================================

model Course {
  id          String   @id @default(cuid())
  slug        String   @unique
  titleAz     String
  titleRu     String
  titleEn     String
  descAz      String   @db.Text
  descRu      String   @db.Text
  descEn      String   @db.Text
  shortDescAz String?  @db.VarChar(300)
  shortDescRu String?  @db.VarChar(300)
  shortDescEn String?  @db.VarChar(300)
  image       String?
  duration    String // e.g., "3 ay", "6 months"
  price       Decimal? @db.Decimal(10, 2)
  level       Level    @default(BEGINNER)
  audience    Audience  @default(ADULTS)
  ageGroup    AgeGroup? // Only for KIDS courses
  categoryId  String
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  order       Int      @default(0)
  syllabus    Json? // [{module: string, topics: string[], hours: number}]
  features    Json? // ["Sertifikat", "Mentor", ...]

  category     Category        @relation(fields: [categoryId], references: [id])
  teachers     TeacherCourse[]
  students     StudentCourse[]
  certificates Certificate[]
  applications Application[]
  groups       Group[]
  reviews      Review[]
  lessons      Lesson[]
  courseProgress  CourseProgress[]
  teacherComments TeacherComment[]
  attendance      Attendance[]
  grades          Grade[]
  schedules       Schedule[]
  assignments     Assignment[]
  quizzes         Quiz[]
  conversations   Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("courses")
}

enum Level {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum Audience {
  KIDS
  ADULTS
}

// Age group for kids courses (school grades / age ranges)
enum AgeGroup {
  AGE_6_8    // 1-2 sinif
  AGE_9_11   // 3-5 sinif
  AGE_12_14  // 6-8 sinif
  AGE_15_17  // 9-11 sinif
}

model Category {
  id      String   @id @default(cuid())
  nameAz  String
  nameRu  String
  nameEn  String
  slug    String   @unique
  icon    String? // Lucide icon name
  order   Int      @default(0)
  courses Course[]

  createdAt DateTime @default(now())

  @@map("categories")
}

// ==========================================
// TEACHERS
// ==========================================

model Teacher {
  id             String  @id @default(cuid())
  email          String? @unique // For Teacher Portal login
  password       String? // Hashed password for Teacher Portal
  nameAz         String
  nameRu         String
  nameEn         String
  bioAz          String? @db.Text
  bioRu          String? @db.Text
  bioEn          String? @db.Text
  photo          String?
  specialization String?
  linkedin       String?
  github         String?
  website        String?
  isActive       Boolean @default(true)
  order          Int     @default(0)

  courses           TeacherCourse[]
  certificates      Certificate[]
  reviewsGiven      Review[]        @relation("TeacherReviews")
  reviewsReceived   Review[]        @relation("ReviewsAboutTeacher")
  teacherComments   TeacherComment[]
  grades            Grade[]
  attendanceMarked  Attendance[]
  schedules         Schedule[]
  assignments       Assignment[]
  quizzes           Quiz[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("teachers")
}

model TeacherCourse {
  teacherId String
  courseId   String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@id([teacherId, courseId])
  @@map("teacher_courses")
}

// ==========================================
// STUDENTS
// ==========================================

model Student {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?
  photo     String?
  password  String?  // bcrypt hash for Student Portal login
  isActive  Boolean  @default(true)
  lastLoginAt DateTime?

  courses         StudentCourse[]
  certificates    Certificate[]
  reviewsGiven    Review[]        @relation("StudentReviews")
  reviewsReceived Review[]        @relation("ReviewsAboutStudent")
  groupId         String?
  group           Group?          @relation(fields: [groupId], references: [id])
  parents         StudentParent[]
  lessonProgress  LessonProgress[]
  courseProgress   CourseProgress[]
  teacherComments TeacherComment[]
  attendance      Attendance[]
  grades          Grade[]
  submissions     AssignmentSubmission[]
  quizAttempts    QuizAttempt[]
  studentBadges   StudentBadge[]
  xpTransactions  XPTransaction[]
  xpTotal         Int              @default(0)
  emailNotifications Boolean       @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("students")
}

model StudentCourse {
  studentId String
  courseId   String
  status    EnrollmentStatus @default(ACTIVE)
  startDate DateTime?
  endDate   DateTime?

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@id([studentId, courseId])
  @@map("student_courses")
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
}

model Group {
  id        String    @id @default(cuid())
  name      String // e.g., "Frontend Batch #5"
  courseId   String
  startDate DateTime?
  endDate   DateTime?

  course   Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  students Student[]

  createdAt DateTime @default(now())

  @@index([courseId])
  @@map("groups")
}

// ==========================================
// CERTIFICATES
// ==========================================

model Certificate {
  id            String            @id @default(cuid())
  uniqueCode    String            @unique @default(cuid())
  studentId     String
  courseId       String
  teacherId     String
  issueDate     DateTime          @default(now())
  pdfUrl        String?
  qrCodeUrl     String?
  teacherReview String?           @db.Text
  grade         String? // "Excellent", "Good", etc.
  status        CertificateStatus @default(ACTIVE)

  student Student @relation(fields: [studentId], references: [id])
  course  Course  @relation(fields: [courseId], references: [id])
  teacher Teacher @relation(fields: [teacherId], references: [id])

  createdAt DateTime @default(now())

  @@map("certificates")
}

enum CertificateStatus {
  ACTIVE
  REVOKED
}

// ==========================================
// APPLICATIONS
// ==========================================

model Application {
  id       String            @id @default(cuid())
  name     String
  email    String
  phone    String
  courseId  String?
  message  String?           @db.Text
  status   ApplicationStatus @default(NEW)
  notes    String?           @db.Text // Admin notes

  // UTM tracking fields (from ads)
  utmSource   String?    // e.g., "instagram", "facebook", "tiktok"
  utmMedium   String?    // e.g., "cpc", "social", "email"
  utmCampaign String?    // e.g., "summer2026", "launch-promo"

  course Course? @relation(fields: [courseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("applications")
}

enum ApplicationStatus {
  NEW
  CONTACTED
  ENROLLED
  REJECTED
}

// ==========================================
// NEWS / BLOG
// ==========================================

model News {
  id          String    @id @default(cuid())
  slug        String    @unique
  titleAz     String
  titleRu     String
  titleEn     String
  contentAz   String    @db.Text
  contentRu   String    @db.Text
  contentEn   String    @db.Text
  excerptAz   String?   @db.VarChar(300)
  excerptRu   String?   @db.VarChar(300)
  excerptEn   String?   @db.VarChar(300)
  image       String?
  isPublished Boolean   @default(false)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("news")
}

// ==========================================
// TESTIMONIALS
// ==========================================

model Testimonial {
  id       String  @id @default(cuid())
  name     String
  photo    String?
  textAz   String  @db.Text
  textRu   String  @db.Text
  textEn   String  @db.Text
  rating   Int     @default(5)
  courseAz String?
  courseRu String?
  courseEn String?
  isActive Boolean @default(true)
  order    Int     @default(0)

  createdAt DateTime @default(now())

  @@map("testimonials")
}

// ==========================================
// PARTNERS
// ==========================================

model Partner {
  id      String  @id @default(cuid())
  name    String
  logoUrl String
  website String?
  order   Int     @default(0)

  createdAt DateTime @default(now())

  @@map("partners")
}

// ==========================================
// REVIEWS (with moderation)
// ==========================================

model Review {
  id     String     @id @default(cuid())
  type   ReviewType
  text   String     @db.Text
  rating Int        @default(5)

  // Author (who writes the review)
  studentAuthorId String?
  teacherAuthorId String?

  studentAuthor Student? @relation("StudentReviews", fields: [studentAuthorId], references: [id], onDelete: Cascade)
  teacherAuthor Teacher? @relation("TeacherReviews", fields: [teacherAuthorId], references: [id], onDelete: Cascade)

  // Subject (what/who the review is about)
  aboutCourseId  String?
  aboutTeacherId String?
  aboutStudentId String?

  aboutCourse  Course?  @relation(fields: [aboutCourseId], references: [id], onDelete: Cascade)
  aboutTeacher Teacher? @relation("ReviewsAboutTeacher", fields: [aboutTeacherId], references: [id], onDelete: Cascade)
  aboutStudent Student? @relation("ReviewsAboutStudent", fields: [aboutStudentId], references: [id], onDelete: Cascade)

  // Moderation
  status      ReviewStatus @default(PENDING)
  moderatedBy String? // Admin user ID
  moderatedAt DateTime?
  adminNote   String?      @db.Text // Rejection reason

  isPublic Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reviews")
}

enum ReviewType {
  STUDENT_ABOUT_COURSE
  STUDENT_ABOUT_TEACHER
  TEACHER_ABOUT_STUDENT
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==========================================
// SCHOLARSHIPS (Стипендионные программы)
// ==========================================

model Scholarship {
  id          String   @id @default(cuid())
  slug        String   @unique
  titleAz     String
  titleRu     String
  titleEn     String
  descAz      String   @db.Text
  descRu      String   @db.Text
  descEn      String   @db.Text
  coverageAz  String?  @db.Text // Что покрывает стипендия
  coverageRu  String?  @db.Text
  coverageEn  String?  @db.Text
  eligibilityAz String? @db.Text // Критерии
  eligibilityRu String? @db.Text
  eligibilityEn String? @db.Text
  amount      Decimal? @db.Decimal(10, 2) // Сумма или процент скидки
  percentage  Int?     // Процент покрытия (50%, 100%)
  deadline    DateTime?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  image       String?

  applications ScholarshipApplication[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("scholarships")
}

model ScholarshipApplication {
  id            String              @id @default(cuid())
  scholarshipId String
  name          String
  email         String
  phone         String
  motivation    String?             @db.Text // Мотивационное письмо
  resume        String?             // URL к резюме
  status        ScholarshipAppStatus @default(PENDING)
  notes         String?             @db.Text // Заметки админа

  scholarship Scholarship @relation(fields: [scholarshipId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("scholarship_applications")
}

enum ScholarshipAppStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

// ==========================================
// CORPORATE / B2B (Корпоративные решения)
// ==========================================

model CorporateService {
  id          String   @id @default(cuid())
  slug        String   @unique
  type        CorporateServiceType
  titleAz     String
  titleRu     String
  titleEn     String
  descAz      String   @db.Text
  descRu      String   @db.Text
  descEn      String   @db.Text
  shortDescAz String?  @db.VarChar(300)
  shortDescRu String?  @db.VarChar(300)
  shortDescEn String?  @db.VarChar(300)
  icon        String?  // Lucide icon name
  image       String?
  features    Json?    // Ключевые возможности
  isActive    Boolean  @default(true)
  order       Int      @default(0)

  inquiries CorporateInquiry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("corporate_services")
}

enum CorporateServiceType {
  TRAINING        // Корпоративные тренинги
  UPSKILLING      // Повышение квалификации
  IT_SOLUTION     // IT-решения (QA, пентест, разработка)
}

model CorporateInquiry {
  id          String              @id @default(cuid())
  serviceId   String?
  companyName String
  contactName String
  email       String
  phone       String
  message     String?             @db.Text
  employeeCount String?           // Количество сотрудников
  budget      String?             // Бюджет
  status      CorporateInqStatus  @default(NEW)
  notes       String?             @db.Text

  service CorporateService? @relation(fields: [serviceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("corporate_inquiries")
}

enum CorporateInqStatus {
  NEW
  CONTACTED
  PROPOSAL_SENT
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

// ==========================================
// LESSONS & MATERIALS (LMS)
// ==========================================

model Lesson {
  id          String   @id @default(cuid())
  courseId    String
  titleAz     String
  titleRu     String
  titleEn     String
  descAz      String?  @db.Text
  descRu      String?  @db.Text
  descEn      String?  @db.Text
  order       Int      @default(0)
  isPublished Boolean  @default(false)

  course     Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  materials  LessonMaterial[]
  lessonProgress  LessonProgress[]
  teacherComments TeacherComment[]
  grades          Grade[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("lessons")
}

model LessonMaterial {
  id       String       @id @default(cuid())
  lessonId String
  title    String       // Display name
  type     MaterialType
  url      String       // Link to Google Slides, Docs, Drive, YouTube, etc.
  order    Int          @default(0)

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("lesson_materials")
}

enum MaterialType {
  SLIDES       // Google Slides, PowerPoint
  DOCUMENT     // Google Docs, PDF, Word
  VIDEO        // YouTube, Vimeo
  SPREADSHEET  // Google Sheets, Excel
  LINK         // Generic link
  FILE         // Downloadable file
}

// ==========================================
// PARENTS (LMS)
// ==========================================

model Parent {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String   // bcrypt hash
  nameAz      String
  nameRu      String
  nameEn      String
  phone       String?
  avatar      String?
  isActive    Boolean  @default(true)
  lastLoginAt DateTime?

  children StudentParent[]
  emailNotifications Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("parents")
}

model StudentParent {
  id        String         @id @default(cuid())
  studentId String
  parentId  String
  relation  ParentRelation @default(PARENT)

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parent  Parent  @relation(fields: [parentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([studentId, parentId])
  @@map("student_parents")
}

enum ParentRelation {
  MOTHER
  FATHER
  GUARDIAN
  PARENT
}

// ==========================================
// PROGRESS TRACKING (LMS)
// ==========================================

model LessonProgress {
  id          String         @id @default(cuid())
  studentId   String
  lessonId    String
  status      ProgressStatus @default(NOT_STARTED)
  startedAt   DateTime?
  completedAt DateTime?
  timeSpentSec Int           @default(0)

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lesson  Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([studentId, lessonId])
  @@map("lesson_progress")
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model CourseProgress {
  id             String   @id @default(cuid())
  studentId      String
  courseId        String
  percentage     Float    @default(0)
  lastAccessedAt DateTime?

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@map("course_progress")
}

// ==========================================
// TEACHER COMMENTS (LMS)
// ==========================================

model TeacherComment {
  id        String      @id @default(cuid())
  teacherId String?
  studentId String
  courseId   String
  lessonId  String?
  comment   String      @db.Text
  type      CommentType @default(PROGRESS)

  teacher Teacher? @relation(fields: [teacherId], references: [id])
  student Student  @relation(fields: [studentId], references: [id])
  course  Course  @relation(fields: [courseId], references: [id])
  lesson  Lesson? @relation(fields: [lessonId], references: [id])

  createdAt DateTime @default(now())

  @@map("teacher_comments")
}

enum CommentType {
  PROGRESS
  BEHAVIOR
  ACHIEVEMENT
  GENERAL
}

// ==========================================
// ATTENDANCE (LMS)
// ==========================================

model Attendance {
  id        String           @id @default(cuid())
  studentId String
  courseId   String
  teacherId String?
  groupId   String?
  date      DateTime
  status    AttendanceStatus @default(PRESENT)
  note      String?

  student Student  @relation(fields: [studentId], references: [id])
  course  Course   @relation(fields: [courseId], references: [id])
  teacher Teacher? @relation(fields: [teacherId], references: [id])

  createdAt DateTime @default(now())

  @@unique([studentId, courseId, date])
  @@map("attendance")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

// ==========================================
// GRADES (LMS)
// ==========================================

model Grade {
  id        String    @id @default(cuid())
  studentId String
  courseId   String
  lessonId  String?
  teacherId String?
  value     Float     // numeric grade (0-100)
  maxValue  Float     @default(100)
  type      GradeType @default(ASSIGNMENT)
  comment   String?

  student Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson  Lesson?  @relation(fields: [lessonId], references: [id])
  teacher Teacher? @relation(fields: [teacherId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@index([courseId])
  @@index([teacherId])
  @@map("grades")
}

enum GradeType {
  ASSIGNMENT
  QUIZ
  EXAM
  PROJECT
  PARTICIPATION
}

// ==========================================
// SCHEDULE (расписание)
// ==========================================

model Schedule {
  id        String   @id @default(cuid())
  courseId   String
  teacherId  String?
  dayOfWeek  Int      // 1=Monday, 2=Tuesday, ..., 6=Saturday, 0=Sunday
  startTime  String   // "09:00"
  endTime    String   // "10:30"
  room       String?  // "Room 301"
  isActive   Boolean  @default(true)

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher Teacher? @relation(fields: [teacherId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("schedules")
}

// ==========================================
// ASSIGNMENTS (Домашние задания)
// ==========================================

model Assignment {
  id          String   @id @default(cuid())
  courseId     String
  teacherId   String?
  title       String
  description String?  @db.Text
  dueDate     DateTime?
  maxScore    Float    @default(100)
  isActive    Boolean  @default(true)

  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher     Teacher? @relation(fields: [teacherId], references: [id])
  submissions AssignmentSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("assignments")
}

model AssignmentSubmission {
  id           String           @id @default(cuid())
  assignmentId String
  studentId    String
  fileUrl      String?          // Uploaded file URL
  linkUrl      String?          // External link (GitHub, etc.)
  text         String?          @db.Text // Text answer
  grade        Float?           // Teacher's grade
  feedback     String?          @db.Text // Teacher's feedback
  status       SubmissionStatus @default(NOT_SUBMITTED)

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  submittedAt DateTime?
  gradedAt    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([assignmentId, studentId])
  @@map("assignment_submissions")
}

enum SubmissionStatus {
  NOT_SUBMITTED
  SUBMITTED
  LATE
  GRADED
  RETURNED // Teacher returned for revision
}

// ==========================================
// NOTIFICATIONS (Уведомления)
// ==========================================

model Notification {
  id        String           @id @default(cuid())
  userId    String           // Can be student, teacher, parent, admin
  userType  String           // "student" | "teacher" | "parent" | "admin"
  type      NotificationType
  title     String
  message   String           @db.Text
  link      String?          // URL to navigate to
  isRead    Boolean          @default(false)

  createdAt DateTime @default(now())

  @@index([userId, userType])
  @@index([userId, isRead])
  @@map("notifications")
}

enum NotificationType {
  NEW_GRADE
  NEW_ASSIGNMENT
  ASSIGNMENT_GRADED
  ASSIGNMENT_DUE
  NEW_COMMENT
  ATTENDANCE_MARKED
  COURSE_UPDATE
  NEW_QUIZ
  QUIZ_GRADED
  NEW_MESSAGE
  BADGE_EARNED
  SYSTEM
}

// ==========================================
// QUIZZES (Онлайн тесты)
// ==========================================

model Quiz {
  id          String    @id @default(cuid())
  courseId     String
  teacherId   String?
  title       String
  description String?   @db.Text
  timeLimit   Int?      // Time limit in minutes (null = no limit)
  maxAttempts Int       @default(1) // How many times student can attempt
  passingScore Float?   // Minimum score to pass (percentage)
  isActive    Boolean   @default(true)
  isPublished Boolean   @default(false)
  showResults Boolean   @default(true) // Show results after completion
  shuffleQuestions Boolean @default(false)

  course    Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher   Teacher?       @relation(fields: [teacherId], references: [id])
  questions QuizQuestion[]
  attempts  QuizAttempt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("quizzes")
}

model QuizQuestion {
  id           String       @id @default(cuid())
  quizId       String
  type         QuestionType
  question     String       @db.Text // Supports markdown
  options      Json?        // For MC/TF: [{id: string, text: string}]
  correctAnswer Json        // For MC: ["optionId"], TF: ["true"/"false"], OPEN: ["expected answer"]
  points       Float        @default(1)
  explanation  String?      @db.Text // Shown after answering
  order        Int          @default(0)

  quiz    Quiz          @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers QuizAnswer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("quiz_questions")
}

enum QuestionType {
  MULTIPLE_CHOICE   // Single correct answer
  MULTIPLE_SELECT   // Multiple correct answers
  TRUE_FALSE
  OPEN_ENDED        // Text answer (manual grading)
  CODE              // Code answer (manual grading)
}

model QuizAttempt {
  id          String        @id @default(cuid())
  quizId      String
  studentId   String
  score       Float?        // Calculated score (percentage)
  totalPoints Float?        // Total points earned
  maxPoints   Float?        // Maximum possible points
  status      AttemptStatus @default(IN_PROGRESS)
  startedAt   DateTime      @default(now())
  completedAt DateTime?
  timeSpentSec Int?         // Time spent in seconds

  quiz    Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  answers QuizAnswer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("quiz_attempts")
}

enum AttemptStatus {
  IN_PROGRESS
  COMPLETED
  TIMED_OUT
  GRADED
}

model QuizAnswer {
  id          String   @id @default(cuid())
  attemptId   String
  questionId  String
  answer      Json     // Student's answer: ["selectedOptionId"] or ["text answer"]
  isCorrect   Boolean? // null for open-ended/code (needs manual grading)
  pointsEarned Float?  // Points earned for this answer

  attempt  QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([attemptId, questionId])
  @@map("quiz_answers")
}

// ==========================================
// SITE SETTINGS
// ==========================================

model SiteSetting {
  id    String @id @default(cuid())
  key   String @unique
  value String @db.Text

  @@map("site_settings")
}

// ==========================================
// MESSAGING (Чат учитель ↔ студент)
// ==========================================

model Conversation {
  id        String   @id @default(cuid())
  courseId   String?  // null = direct message, set = course group chat
  title      String?  // for group chats
  isGroup    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course       Course?                  @relation(fields: [courseId], references: [id])
  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  userType       String   // "student" | "teacher" | "admin"
  lastReadAt     DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId, userType])
  @@index([userId, userType])
  @@map("conversation_participants")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  senderType     String   // "student" | "teacher" | "admin"
  text           String   @db.Text
  fileUrl        String?  // Cloudinary attachment
  fileName       String?
  isEdited       Boolean  @default(false)
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}

// ==========================================
// GAMIFICATION (Бейджи + XP + Лидерборд)
// ==========================================

model Badge {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String
  icon        String   // emoji
  category    String   // "learning", "attendance", "quiz", "social"
  condition   Json     // {"type": "lessons_completed", "value": 1}
  xpReward    Int      @default(0)
  isActive    Boolean  @default(true)
  order       Int      @default(0)

  studentBadges StudentBadge[]

  createdAt DateTime @default(now())

  @@map("badges")
}

model StudentBadge {
  id        String   @id @default(cuid())
  studentId String
  badgeId   String
  awardedAt DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  badge   Badge   @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([studentId, badgeId])
  @@map("student_badges")
}

model XPTransaction {
  id        String   @id @default(cuid())
  studentId String
  amount    Int
  reason    String   // "lesson_completed", "quiz_passed", "assignment_submitted"
  sourceId  String?  // ID of lesson/quiz/assignment
  createdAt DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, createdAt])
  @@map("xp_transactions")
}
